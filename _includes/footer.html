<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script type="text/javascript" src="{{ "/assets/bootstrap/js/bootstrap.min.js" | relative_url }}"></script>
{%- if page.url == '/' -%}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
<script type="text/javascript">
  function createChart(labels, dat) {
    const styles = getComputedStyle(document.body);
    const ruffleBlue = styles.getPropertyValue("--ruffle-blue");
    const ruffleOrange = styles.getPropertyValue("--ruffle-orange");
    const ctx = $("#weekly-commits");
    const data = {
      labels: labels,
      datasets: [{
        data: dat,
        backgroundColor: ruffleOrange,
        hoverBackgroundColor: ruffleOrange
      }]
    };

    const options = {
      scales: {
        y: {
          ticks: {
            beginAtZero: true,
            color: ruffleOrange
          },
          grid: {
            drawBorder: false,
            display: false
          }
        },
        x: {
          ticks: {
            maxTicksLimit: (context) => context.chart.width > 500 ? 18 : 9,
            color: ruffleOrange
          },
          grid: {
            drawBorder: false,
            display: false
          }
        }
      },
      plugins: {
        title: {
          display: true,
          position: "top",
          text: "Weekly Contributions",
          color: ruffleOrange,
          font: {
            size: 18,
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: ruffleOrange,
          borderWidth: 1,
          borderColor: "#1a2743",
          titleColor: ruffleBlue,
          titleMarginBottom: 0,
          callbacks: {
            title: (t) => t[0].formattedValue + " commits the week of " +
              new Date(t[0].label).toLocaleString(undefined, {
                timeZone: "UTC",
                month: "short",
                day: "numeric"
              }),
            label: () => ""
          }
        }
      }
    };

    const chart = new Chart(ctx, {
      type: "bar",
      data: data,
      options: options
    });
  }

  $(document).ready(function () {
    var $nav = $('.navbar');
    var $headerarrow = $('.header-down-arrow');
    //$nav.hide();

    // fade in .navbar
    $(function () {
      $(window).on('scroll load', function () {
        // set distance user needs to scroll before we start fadeIn
        if ($(this).scrollTop() > window.innerHeight / 2) { //For dynamic effect use $nav.height() instead of '100'
          //$nav.fadeIn();
          $nav.addClass("active");
          $headerarrow.fadeOut();
        } else {
          //$nav.fadeOut();
          $nav.removeClass("active");
          $headerarrow.fadeIn();
        }
      });
    });
    fetch("https://api.github.com/repos/ruffle-rs/ruffle/stats/commit_activity")
      .then(response => response.json())
      .then(data => {
        const labels = [];
        const dat = [];
        for (const row of data) {
          if (row.total && row.week) {
            dat.push(row.total);
            labels.push(
              new Date(row.week * 1000).toISOString().split("T")[0]
            );
          }
        }
        createChart(labels, dat);
      });
  });
</script>
{%- endif -%}
{%- if page.url == '/avm2.html' -%}
<script type="text/javascript">
async function getJSONResponse(url) {
  return fetch(reportURL)
    .then(response => response.json())
    .then(json => {
      return json
    });
}
async function createProgressBar(section, implementationPoints, maxPoints, stubPenalties, missing, stubs) {
  const classElement = document.createElement("H3");
  classElement.textContent = section + "\u2003";
  const classes = document.getElementById("classes");
  const classProgressBar = document.createElement("DIV");
  const greenPercent = (implementationPoints - stubPenalties) / maxPoints * 100;
  const yellowPercent = stubPenalties / maxPoints * 100;
  const codeElement = document.createElement("CODE");
  codeElement.innerText = Math.round(greenPercent) + "% implemented";
  if (Math.round(yellowPercent) > 0) {
    codeElement.innerText += ", " + Math.round(yellowPercent) + "% stubbed";
  }
  classElement.appendChild(codeElement);
  classProgressBar.className = "progress-bar";
  classProgressBar.title = codeElement.innerText;
  const root = document.querySelector(':root');
  classProgressBar.style.setProperty('--green-percent', greenPercent + "%");
  classProgressBar.style.setProperty('--yellow-end-percent', greenPercent + yellowPercent + "%");
  const missingDetails = document.createElement("DETAILS");
  const missingSummary = document.createElement("SUMMARY");
  missingSummary.innerText = "Missing";
  missingDetails.appendChild(missingSummary);
  const missingList = document.createElement("UL");
  missing.forEach(missing => {
    missingElement = document.createElement("LI");
    missingElement.innerText = missing;
    missingList.appendChild(missingElement);
  });
  missingDetails.appendChild(missingList);
  const stubDetails = document.createElement("DETAILS");
  const stubSummary = document.createElement("SUMMARY");
  stubSummary.innerText = "Stubbed";
  stubDetails.appendChild(stubSummary);
  const stubList = document.createElement("UL");
  stubs.forEach(stub => {
    stubElement = document.createElement("LI");
    stubElement.innerText = stub;
    stubList.appendChild(stubElement);
  });
  stubDetails.appendChild(stubList);
  classes.appendChild(classElement);
  classes.appendChild(classProgressBar);
  if (missing.length > 0) classes.appendChild(missingDetails);
  if (stubs.length > 0) classes.appendChild(stubDetails);
}
async function getImplementationAmounts(responseJSON, section) {
  let implementationPoints = 0;
  let maxPoints = 0;
  let stubPenalties = 0;
  const missing = [];
  const stubs = [];
  if (section === "ActionScript 3 API") {
    const summaryAmounts = responseJSON["summary"];
    implementationPoints = summaryAmounts["impl_points"];
    maxPoints = summaryAmounts["max_points"];
    stubPenalties = summaryAmounts["stub_penalty"];
    createProgressBar(section, implementationPoints, maxPoints, stubPenalties, missing, stubs);
    return;
  }
  const allClasses = Object.keys(responseJSON["classes"]);
  const sectionClasses = section !== "Top Level" ? allClasses.filter(className => new RegExp(section.replace(".", "\\.") + "(\\.|$)").test(className)) : allClasses.filter(className => !className.includes("."));
  sectionClasses.forEach(className => {
    const summaryAmounts = responseJSON["classes"][className]["summary"];
    implementationPoints += summaryAmounts["impl_points"];
    maxPoints += summaryAmounts["max_points"];
    stubPenalties += summaryAmounts["stub_penalty"];
    if (implementationPoints === 0) missing.push(className);
    else missing.push(...(responseJSON["classes"][className]["missing"].map(el => className + ": " + el)));
    stubs.push(...(responseJSON["classes"][className]["stubbed"].map(el => className + ": " + el)))
  });
  createProgressBar(section, implementationPoints, maxPoints, stubPenalties, missing, stubs);
}
async function getSections(url) {
  const responseJSON = await getJSONResponse(url);
  const allClasses = Object.keys(responseJSON["classes"]);
  const sectionClasses = allClasses.filter(className => className.match(".*\\..*"));
  const sectionArray = sectionClasses.map(className => className.split(".").slice(0, 2).join("."));
  const sections = ["ActionScript 3 API", "Top Level", ...new Set(sectionArray)];
  sections.forEach(section => getImplementationAmounts(responseJSON, section));
}
getSections(reportURL);
</script>
{%- endif -%}
<footer class="site-footer h-card">
  <data class="u-url" href="{{ "/" | relative_url }}"></data>
  <ul>
    <li>
      <a class="navbar-brand" href="#">
        <img src="{{ "/assets/logo.svg" | relative_url }}" width="91" height="auto" alt="Ruffle" loading="lazy">
      </a>
    </li>
    <li class="social">
      {%- include social.html -%}
    </li>
    <li class="description">
      <p>{{- site.description | escape -}}</p>
    </li>
    </div>
  </ul>
</footer>
